---
title: "Growth rates in A. cervicornis by Genotypes"
author: "Ana Palacio"
date: "Feb 13, 2020"
output:
  html_document:
    fig_height: 3.5
    fig_width: 6
    df_print: paged
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

# 1. General project set-up 

```{r libraries, results="hide"}

# Load all libraries and sources required to run the script
    library(tidyverse)
    library(ggthemes)
    library(lmerTest)
    library(emmeans)
    library(multcomp)
    library(gridExtra)
    library(nlme)
    library(lattice)
    library(rms)

# Default ggplot settings

 ggthe_bw<-theme_bw() + theme(panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    #panel.background = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    plot.background=element_blank(),
                    legend.title = element_blank(), 
                    legend.box.background = element_rect(),
                    panel.background =element_rect(fill = NA, color = "white"),
                    legend.position=c(0.2, 0.5),
                    strip.background =element_rect(fill=NA))
```


# 2. Import and clean growth data

```{r}
# Import data: 

  ## Growth long
    BW.Tall<-read.csv("Growth_corrected.csv", header = TRUE)
    
  ## Genotype information
    MOTE<-read.csv("Genotype_Info.csv", header = TRUE)
    BW.Tall<-merge(BW.Tall, MOTE, by="Gen", all.x=TRUE)
    
  ## Data type  
    BW.Tall$Initial.Date<-as.Date(BW.Tall$Initial.Date, "%m/%d/%y")
    BW.Tall$Final.Date<-as.Date(BW.Tall$Final.Date, "%m/%d/%y")
    BW.Tall$Days<-(as.numeric(as.Date(BW.Tall$Final.Date))-17485)
    BW.Tall$DayF<-(as.factor(BW.Tall$Days))
    BW.Tall$DayF<-factor(BW.Tall$DayF, levels = c("-28", "28", "62", "75", "91", "100"))
   
    ## corSymm requires consecutive integers 
    BW.Tall$TimePoint[BW.Tall$DayF=="-28"]<-"1"
    #BW.Tall$TimePoint[BW.Tall$DayF=="-7"]<-"4"
    BW.Tall$TimePoint[BW.Tall$DayF=="28"]<-"2"
    BW.Tall$TimePoint[BW.Tall$DayF=="62"]<-"3"
    BW.Tall$TimePoint[BW.Tall$DayF=="75"]<-"4"
    BW.Tall$TimePoint[BW.Tall$DayF=="91"]<-"5"
    BW.Tall$TimePoint[BW.Tall$DayF=="100"]<-"6"
    BW.Tall$TimePoint[BW.Tall$DayF=="113"]<-"7"
    BW.Tall$TimePoint<-as.numeric(BW.Tall$TimePoint)

    BW.Tall$Treatment <- as.character(BW.Tall$Treatment)
    BW.Tall$Treatment[BW.Tall$Treatment == "Control"] <- "Ambient"
    BW.Tall$Treatment[BW.Tall$Treatment == "N"] <- "NH4"
    BW.Tall$Treatment[BW.Tall$Treatment == "NP"] <- "NH4+PO4"
    BW.Tall$Treatment <- as.factor(BW.Tall$Treatment)
    
    BW.Tall$Nutrients <- "Nutrients"
    BW.Tall$Nutrients[BW.Tall$Treatment == "Ambient"] <- "Ambient"
    BW.Tall$Nutrients<-as.factor(BW.Tall$Nutrients)
    
    BW.Tall$Nutrients2 <- BW.Tall$Nutrients
    BW.Tall$Nutrients2[BW.Tall$DayF == "-28"] <- "Ambient"
    BW.Tall$Nutrients2<-as.factor(BW.Tall$Nutrients2)
    
    BW.Tall$Fra <- as.factor(BW.Tall$Fra)
    
    #BW.Tall$Colony <- as.factor(BW.Tall$Gen)
    BW.Tall$MoteGen<-factor(BW.Tall$MoteGen, 
                                   levels=c("G_48", "G_62","G_31", "G_08","G_07", "G_50"))
    BW.Tall$SampleID <- paste("Ac", BW.Tall$Fra, BW.Tall$TimePoint, sep = "_")
  
  # Remove unused columns    
    BW.Tall$Gen<-NULL
    BW.Tall$Time <-NULL
    BW.Tall$Period<-NULL
    BW.Tall$Original.Collection.Date <-NULL
    BW.Tall$Collection.Habitat <-NULL
    BW.Tall$Lat <-NULL
    BW.Tall$Lon <-NULL
    BW.Tall$WBS <-NULL
    
  # Remove recovery data points
    BW.Tall<-subset(BW.Tall, Initial.Date!="2017-10-18")
    BW.Tall<-subset(BW.Tall, Initial.Date!="2018-02-23") # After heat stress
    
    
  
```

Fragments meassured per timepoint and genotype 

```{r}
N.fragments<-BW.Tall %>% 
     group_by(MoteGen) %>% dplyr::count(DayF)
N.fragments

```

# 3. Nutrient treatment means overtime

## Figure 3a

```{r, fig.height=3.5, fig.width=3.5}

Fill.colour<-scale_colour_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))

# Treatment effect over time

    BW_Treat<- ggplot(BW.Tall, aes (Days, dAW.gd, fill=Treatment, shape=factor(Treatment))) + 
      scale_shape_manual(values=c(21, 22, 24), labels=c("Ambient", "NH4", "NH4+PO4"))+
      ggthe_bw + Fill.colour + ggtitle("a")+
  
      stat_summary(fun.data = "mean_cl_boot", geom = "errorbar",
                   position=position_dodge(width=5))+
      stat_summary(fun.y=mean, geom="line", 
                   position=position_dodge(width=5), linetype=1) +
      stat_summary(fun.y=mean, geom="point", size =2,  alpha=0.8,
                   position=position_dodge(width=5))  + 
  
      scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(-30, 115, by=15)) +
      scale_y_continuous(name="Growth (mg  g-1 d-1)", 
                         breaks = seq(-1, 4, by=1)) +
  
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray35")+
      annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray35", linetype="dashed")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = 3.5,
                colour = "gray35", linetype="dotted")+
    
      annotate("segment", x = 91, xend = 110, y = 3.5, yend = 3.5,
                colour = "gray35", linetype="dotted")+
      annotate("text", x = 99, y = -1.2, label = "Heat", size=3)
  BW_Treat
  
# ggsave(file="Outputs/Figure3_BW_corrected.svg", plot=BW_Treat, dpi = 300, units="in", width=3.0, height=3.5)
```

## Overall model (genotype as random effects)

```{r}

# Linear model 
  Model_treatment<-lmer(dAW.gd~Treatment * DayF + (1|Genotype) + (1|Fra) + (1|Replicate),
                        data = BW.Tall)
  anova(Model_treatment)
  ranova(Model_treatment)
  #summary(Model_treatment)

# Pairwise comparisons
  # Day specific comparissions
  BW.emmc<-emmeans(Model_treatment, ~Treatment|DayF)
  BW_groups<-cld(BW.emmc)
  BW_groups
  
  # Across days (temperature) comparissions
  BW.emmc<-emmeans(Model_treatment, ~Treatment*DayF)
  BW_groups<-cld(BW.emmc)
  BW_groups<-BW_groups[order(BW_groups$DayF,BW_groups$Treatment),]
  BW_groups
```

# 4.1 Genotypes

## 4.1 Genotypes and nutrient treatment means over time

### Figure 3b

```{r, echo =FALSE}

BW.Tall$TreatmentG<-BW.Tall$Treatment
BW.Tall$TreatmentG[BW.Tall$DayF==-28] <-"Ambient"

Colour.colour<-scale_colour_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))
Fill.colour<-scale_fill_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))

BW_Col <- ggplot(BW.Tall, aes(Days, dAW.gd, fill=Treatment,
                              shape=factor(Treatment))) +
  
     annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray35")+
      # annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray35", linetype="dashed")+
      # annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = 4.5,
                colour = "gray35", linetype="dotted")+
    
      annotate("segment", x = 91, xend = 110, y = 4.5, yend = 4.5,
                colour = "gray35",  linetype="dotted")+
      # annotate("text", x = 99, y = 3.5, label = "H", size=4)+
  
           stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", 
                        position=position_dodge(width=5), width = 10)+
           stat_summary(fun.y=mean, geom="point", size =2,
                        position=position_dodge(width=5), alpha=0.8) +
           stat_summary(fun.y=mean, geom="line", 
                        position=position_dodge(width=5), linetype=1) + 
    scale_shape_manual(values=c(21, 22, 24),
                     labels=c("Ambient", "NH4", "NH4+PO4"))+
    ggthe_bw + Colour.colour + Fill.colour + ggtitle("b") +
    scale_x_continuous(name="Days in the experiment",
                           limits = c(-35,113),
                           breaks = seq(-30, 113, 30),  
                           expand = c(0, 0))+
    scale_y_continuous(name=" ", 
                      breaks = seq(-1, 5, by=1)) +
   #geom_hline(yintercept = 0, linetype=3)+
  
    theme(legend.position="none",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +

     facet_wrap(~MoteGen)
BW_Col

#ggsave(file="Outputs/S2a_Growth_genotype.svg", plot=BW_Col, width=6.0, height=3.5)

```

### Figure 3

```{r}
Figure.3<-grid.arrange(BW_Treat, BW_Col,
          ncol = 2,  widths = c(1.5,2))
#ggsave(file="Outputs/Figure3.svg", plot=Figure.3, width=6.5, height=4.5)
```


## 4.1 Genotypes with nutrients (pooled) over time model

```{r}
  BW.Tall$Treatment2 <- "N and N+P"
  BW.Tall$Treatment2[BW.Tall$Treatment=="Ambient"] <- "Ambient"
  BW.Tall$Treatment2<-as.factor(BW.Tall$Treatment2)
  summary (BW.Tall$Treatment2)
```


```{r, echo =FALSE}

BW_Col2 <- ggplot(BW.Tall, aes(Days, dAW.gd, colour=MoteGen)) + ggthe_bw + ggtitle("b")+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 10,
                     position = position_dodge(2), alpha=0.8 )+
  stat_summary(fun.y=mean, geom="line", position = position_dodge(2),
               linetype=1, alpha=0.5) + 
  stat_summary(fun.y=mean, geom="point", size =2, shape=21,
                   position=position_dodge(width=2))  +
  theme(legend.position=c(0.2,0.3), 
        legend.title = element_blank(),
        strip.background = element_rect(fill="white"))+
  
  scale_x_continuous(name="Days in the experiment",
                           limits = c(-35,113),
                           breaks = seq(-30, 113, 15),  
                           expand = c(0, 0))+
  scale_y_continuous(name=("Growth (mg/ g d) "),
                           limits = c(-3,5),
                           breaks = seq(-2, 6, 1),  
                           expand = c(0, 0))+
  
    annotate("segment", x = -30, xend = -2, y = -2.5, yend = -2.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -2.5, yend = -2.5,
                colour = "gray90", linetype=2)+
      annotate("text", x = 45, y = -2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -2.5, yend = -1.5,
                colour = "gray90", linetype=3)+
    
      annotate("segment", x = 91, xend = 110, y = -2.5, yend = -2.5,
                colour = "gray90", linetype=3)+
      annotate("text", x = 99, y = -2, label = "Heat", size=3)+
     facet_grid(~Treatment2)
BW_Col2

#ggsave(file="Outputs/Growth_genotype.svg", plot=BW_Col2, dpi = 300, units="in", width=5.0, height=3.5)


```

* Growth declined in G50, G07 and G08 in A, but increased in G48, G62 and G31

## Individual fragments

Compare individual fragments inside each nutrient treatment

```{r}
BW_ColonyT<- ggplot(BW.Tall, aes (Days, dAW.gd, colour=MoteGen, group=(Fra))) +   
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.8)+
  stat_summary(fun.y=mean, geom="point", size =2, alpha=0.5) +
   ylab("Growth (mg/ g d)") +
  
     annotate("segment", x = 2, xend = 91, y = -1, yend = -1,
                   colour = "gray90", linetype=1)+
     annotate("segment", x = 79, xend = 91, y = -1, yend = -0.5,
                   colour = "gray90", linetype=1)+
     annotate("segment", x = 91, xend = 110, y = -0.5, yend = -0.5,
                   colour = "gray90", linetype=1)+
     annotate("text", x = 45, y = -1.5, label = "Nutrients", size=3)+
     annotate("text", x = 99, y = -1.5, label = "H", size=3)+
  stat_summary(fun.y=mean, geom="line") + ggthe_bw + facet_grid (~Treatment)  
BW_ColonyT+ facet_grid(Treatment~MoteGen)
```


Initial performance vs ambient per genotype: some genotypes declined in growth even without nutrients

```{r, , fig.height=4, fig.width=6}

BW_Init<- ggplot(BW.Initial, aes (MoteGen, dAW.gd, colour=MoteGen)) +
  ggtitle("(a) Baseline")+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.5) + ggthe_bw +
  scale_y_continuous(name=("Growth (mg/ g d) "),
                     limits = c(0,6),
                     breaks = seq(0, 6, by=0.5))+
  theme(legend.position="right",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))

BW_Final<- ggplot(BW.FinalAC, aes (MoteGen, dAW.gd, colour=MoteGen)) +
   ggtitle("(a) Ambient (day 75)")+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.5) + ggthe_bw +
  scale_y_continuous(name=("Growth (mg/ g d) "),
                     limits = c(0,6),
                     breaks = seq(0, 6, by=0.5))+
   ylab("Growth (mg/ g d) ")+
  theme(legend.position="none",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))

BW_Colony_Control<- ggplot(BW.Control, aes (Days, dAW.gd, colour=MoteGen)) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", 
               width = 10, position=position_dodge(width=5)) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.5,
               position=position_dodge(width=5)) +
  stat_summary(fun.y=mean, geom="line", position=position_dodge(width=5)) +
  
  ggthe_bw + # geom_jitter()+
  ggtitle("(b) Ambient - Control") +
  scale_y_continuous(name=("Growth (mg/ g d) "),
                     limits = c(0,6),
                     breaks = seq(0, 6, by=0.5))+
  theme(legend.position="none")


Captivityeffect<-grid.arrange(BW_Init,BW_Final, nrow=1)
Captivityeffect2<-grid.arrange(BW_Init,BW_Colony_Control, nrow=1)
#ggsave(file="Outputs/S_Genotypes.svg", plot=Captivityeffect, width=6, height=3.5)

```

```{r}
BW_Colony_Control<-ggplot(BW.Control, aes (Days, dAW.gd, colour=factor(Fra), group=Fra)) +   
  #stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.8)+
  #stat_summary(fun.y=mean, geom="point", size =2, alpha=0.5) +
  stat_summary(fun.y=mean, geom="line") + ggthe_bw + 
  facet_wrap (~MoteGen)+  geom_point()+ theme(legend.position = "none")
BW_Colony_Control
```

# Summary by treatment

```{r}
summary(BW.Tall)

# Sample means
BW.mean <- aggregate(dAW.gd~Treatment+Days, data=BW.Tall, mean, na.rm=TRUE)
          names(BW.mean)[3] <- "mean"
# sample SDs
BW.sd <- aggregate(dAW.gd~Treatment+Days, data=BW.Tall, sd, na.rm=TRUE)
          names(BW.sd)[3] <- "sd"
# Collect the summary statistics in a dataframe
BW.summaries <- merge(BW.mean, BW.sd)
print(BW.summaries, digits=3)
```

# Summary by Genotype

```{r}
# sample means
BW.mean1 <- aggregate(dAW.gd~Treatment+Days+MoteGen, data=BW.Tall, mean, na.rm=TRUE)
          names(BW.mean1)[4] <- "mean"
      
# sample SDs
BW.sd1 <- aggregate(dAW.gd~Treatment+Days+MoteGen, data=BW.Tall, sd, na.rm=TRUE)
          names(BW.sd1)[4] <- "sd"
          
          
# Collect the summary statistics in a dataframe
    BW.summaries1<-merge(BW.mean1, BW.sd1)
    BW.summaries1<-BW.summaries1[order(BW.summaries1$MoteGen,BW.summaries1$Day),]
    BW.summaries1

```



## Subset timepoints

```{r}
summary(BW.Tall$DayF)
BW.Acer_28<-subset(BW.Tall, DayF=="-28")
BW.Acer75<-subset(BW.Tall, DayF=="75")
BW.Acer92<-subset(BW.Tall, DayF=="91")
BW.Acer110<-subset(BW.Tall, DayF=="100")

BW.AcerTimePoints<-rbind(BW.Acer_28, BW.Acer75, BW.Acer92, BW.Acer110)

BW_Timepoints<- ggplot(BW.AcerTimePoints, aes (DayF, dAW.gd, fill=MoteGen, shape=Nutrients2)) +
  #ggtitle("(a) Baseline")+
  scale_shape_manual(values=c(21, 14),
                     labels=c("A", "N and N+P"))+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.9) + ggthe_bw +
    scale_y_continuous(name=("Growth (mg/ g d) "),
                     limits = c(-1,6),
                     breaks = seq(-1, 6, by=1))+
  theme(legend.position="right",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))+ 
  facet_grid(~MoteGen)
BW_Timepoints

BW_Timepoints<- ggplot(BW.AcerTimePoints, aes (MoteGen, dAW.gd, fill=MoteGen, shape=Nutrients2)) +
  #ggtitle("(a) Baseline")+
  scale_shape_manual(values=c(21, 14),
                     labels=c("A", "N and N+P"))+
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.9) + ggthe_bw +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  scale_y_continuous(name=("Growth (mg/ g d) "),
                     limits = c(-1,6),
                     breaks = seq(-1, 6, by=1))+
  theme(legend.position="right",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))+ 
  facet_grid(~DayF)
BW_Timepoints

#ggsave(file="Outputs/S4_YII_Treat_Colo.svg", plot=BW_Timepoints, width=5.5, height=3)
```


# 1. Non-constrained models

## Only Ambient (Heat by genotype)


```{r}
A_data<-subset(BW.Tall, Treatment=="A")

fit1 <- gls(dAW.gd ~ DayF *MoteGen, data=A_data,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.exclude,
  control=glsControl(opt="optim"))
```

Only Ambient summary model 

```{r}
summary(fit1)

intervals(fit1)
anova(fit1, type="marginal")
getVarCov(fit1)
residuals(fit1, type="pearson")

par(mfrow=c(1,2))
plot(fitted(fit1), residuals(fit1, type="pearson"))
abline(h=0)
qqnorm(residuals(fit1, type="pearson"))
abline(0,1)
```

Predictions 

```{r}
clda_Gls_1 <- Gls(dAW.gd ~ DayF * MoteGen, 
                  correlation=corSymm (form = ~TimePoint|Fra),
        weights=varIdent(form=~1|TimePoint),
        na.action=na.exclude,
        control=glsControl(opt="optim"),
        data=A_data)

data1<-expand.grid(DayF=unique(BW.Tall$DayF),
                   MoteGen=unique(BW.Tall$MoteGen))

predictions_1 <- cbind(data1, 
predict (clda_Gls_1, data1, conf.int=0.95))

predictions_1$Days<-as.numeric(as.character(predictions_1$DayF))

```

Model prediction Ambient (heat) and genotype (tanks?)

```{r}
pd <- position_dodge(2)
limits <- aes(ymax = upper , ymin=lower, shape=MoteGen)

pCI1 <- ggplot(predictions_1, aes(y=linear.predictors, x=Days, 
                                fill=MoteGen)) + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=MoteGen, y=linear.predictors), position=pd, size=0.1) + 
        geom_point(aes(fill=MoteGen), shape=21, position=pd, size=4, alpha=0.8) +
        
        ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "Heat", size=3)
 
 
pCI1
```

### Nomalized ambient before and after heat 

```{r}
# Claculate relative changes (1 - Ambient)
    D75<-subset(predictions_1, DayF=="75" )
    D75 <- subset(D75, select = c(MoteGen, linear.predictors))
    colnames(D75)<-c("MoteGen", "Day75")
    H_effects<-merge(predictions_1, D75, by=c("MoteGen"), all.x = T)
    summary(H_effects)

H_effects$effects<-(H_effects$linear.predictors-H_effects$Day75)
    H_effects$effects_l<-H_effects$lower-H_effects$Day75          
    H_effects$effects_u<-H_effects$upper-H_effects$Day75          
    
```

Difference Ambient (heat)

```{r}
pd <- position_dodge(3)
limits <- aes(ymax = effects_u , ymin=effects_l, shape=MoteGen)

Gen_heat <- ggplot(H_effects, aes(y=effects, x=Days, 
                                fill=MoteGen)) + 
        geom_errorbar(limits, width= 10 , position=pd) + 
        geom_line(aes(group=MoteGen, y=effects), position=pd, size=0.1) + 
        geom_point(aes(fill=MoteGen), shape=21, position=pd, size=4, alpha=0.8) +
        
        ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        #scale_y_continuous(name="Estimated growth (mg / g d) ", 
         #                breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "Heat", size=3)

Gen_heat
```

## Only Treatment

```{r}
fit2 <- gls(dAW.gd~Treatment * DayF, data=subset(BW.Tall),
    correlation=corSymm(form=~TimePoint|Fra),
    weights=varIdent(form=~1|TimePoint),
    na.action=na.exclude,
    control=glsControl(opt="optim"))

```

Only treatment summary model 

```{r}
summary(fit2)
  intervals(fit2)
  anova(fit2, type="marginal")
  getVarCov(fit2)
  #residuals(fit2, type="pearson")
  
  par(mfrow=c(1,2))
  plot(fitted(fit2), residuals(fit2, type="pearson"))
  abline(h=0)
  qqnorm(residuals(fit2, type="pearson"))
  abline(0,1)
```

Predictions 

```{r}
clda_Gls_2 <- Gls(dAW.gd~Treatment * DayF, data=BW.Tall,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.exclude,
  control=glsControl(opt="optim"))

data2<-expand.grid(DayF=unique(BW.Tall$DayF),
                   Treatment=unique(BW.Tall$Treatment))

predictions_2 <- cbind(data2, 
predict (clda_Gls_2, data2, conf.int=0.95))

predictions_2$Days<-as.numeric(as.character(predictions_2$DayF))
```

Model prediction Ambient (heat)
```{r}
pd <- position_dodge(2)
limits <- aes(ymax = upper , ymin=lower, shape=Treatment)

Model_Tratement <- ggplot(predictions_2, aes(y=linear.predictors, x=Days, 
                                fill=Treatment)) + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Treatment, y=linear.predictors), position=pd, size=0.1) + 
        geom_point(aes(fill=Treatment), shape=21, position=pd, size=4, alpha=0.8) +
        
        ggthe_bw+Fill.colour+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "Heat", size=3)
 
Model_Tratement
```


## Treatment and Genotype

```{r}
fit3 <- gls(dAW.gd ~ Treatment * DayF * Genotype, data=BW.nutrients,
     correlation=corSymm(form=~TimePoint|Fra),
      weights=varIdent(form=~1|TimePoint),
      na.action=na.exclude,
      control=glsControl(opt="optim"))

```

Summary model 

```{r}
summary(fit3)

intervals(fit3)
anova(fit3, type="marginal")
getVarCov(fit3)
#residuals(fit3, type="pearson")

par(mfrow=c(1,2))
plot(fitted(fit3), residuals(fit3, type="pearson"))
abline(h=0)
qqnorm(residuals(fit3, type="pearson"))
abline(0,1)
```

Predictions 

```{r}
clda_Gls_3 <- Gls(dAW.gd~ DayF* Treatment * MoteGen, data=BW.nutrients,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.exclude,
  control=glsControl(opt="optim"))


data3<-expand.grid(DayF=unique(BW.nutrients$DayF),
                   Treatment=unique(BW.nutrients$Treatment),
                   MoteGen=unique(BW.nutrients$MoteGen))

predictions_3 <- cbind(data3,
                       predict (clda_Gls_3, data3, conf.int=0.95))

predictions_3$Days<-as.numeric(as.character(predictions_3$Day))
```

Model prediction Ambient (heat)

* This model does not control for baseline!!! 

```{r}
pd <- position_dodge(2)
limits <- aes(ymax = upper , ymin=lower, shape=Treatment)

Model_Tratement <- ggplot(predictions_3, aes(y=linear.predictors, x=Days, 
                                fill=Treatment)) + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Treatment, y=linear.predictors), position=pd, size=0.1) + 
        geom_point(aes(fill=Treatment), shape=21, position=pd, size=4, alpha=0.8) +
        
        ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "Heat", size=3)
 
Model_Tratement + facet_wrap(~MoteGen)
```

# 2. Constrained longitudinal data analysis (cLDA) 
For randomized group studies with a pre-treatment datapoint (Baseline)


References LDA and cLDA:

* Fitzmaurice, Garrett M., et al. Applied Longitudinal Analysis. John Wiley & Sons, 2004.

*Liu GF, Lu K, Mogg R, et al. Should baseline be a covariate or dependent variable in analyses of change from baseline in clinical trials? Stat Med 2009; 28: 2509-2530.

* Pinheiro J, Bates D (2000): Mixed effects models in S and S-Plus. New York: Springer-Verlag.


## Deal with baseline 

* Remove treatment from BL and ambient 

```{r}
BW.Tall$TreatDay<-as.character(paste(BW.Tall$DayF, BW.Tall$Treatment, sep = "_"))
BW.Tall$TreatDay[BW.Tall$Treatment=="A"]<-"0"
BW.Tall$TreatDay[BW.Tall$Day=="-28"]<-"0"

BW.Tall$TreatDay<-factor(BW.Tall$TreatDay)
summary(BW.Tall$TreatDay)
BW.Tall$TreatDay<-factor(BW.Tall$TreatDay, levels = c("0","28_N","28_N+P", "62_N","62_N+P",
                                                      "75_N", "75_N+P","91_N", "91_N+P", "100_N","100_N+P"))

```

* Or remove interaction BL*Time from the matrix 

```{r}
# X<-model.matrix(~DayF*Treatment, data=BW.Tall)
# colnames(X)
# 
# Xalt<- X[, c("DayF28", "DayF62", "DayF75", "DayF91", "DayF100", "DayF28:TreatmentN", "DayF62:TreatmentN",
#              "DayF75:TreatmentN", "DayF91:TreatmentN","DayF100:TreatmentN","DayF28:TreatmentN+P" ,
#              "DayF62:TreatmentN+P",  "DayF75:TreatmentN+P",  "DayF91:TreatmentN+P",  "DayF100:TreatmentN+P")] 
# colnames(Xalt)

```

## Treatment model

```{r}
fit4 <- gls(dAW.gd ~ DayF + TreatDay, data=BW.Tall,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.exclude,
  control=glsControl(opt="optim"))
 
# fit4 <- gls(dAW.gd ~ Xalt, data=BW.Tall,
#   correlation=corSymm(form=~TimePoint|Fra),
#   weights=varIdent(form=~1|TimePoint),
#   na.action=na.exclude,
#   control=glsControl(opt="optim"))

```

Summary model 

```{r}
summary(fit4)
    intervals(fit4)
    anova(fit4, type="marginal")  # type 3 tests
    getVarCov(fit4)
    #residuals(fit4, type="pearson")
    
    par(mfrow=c(1,2))
    plot(fitted(fit4), residuals(fit4, type="pearson"))
    abline(h=0)
    qqnorm(residuals(fit4, type="pearson"))
    abline(0,1)
```

Predictions 

```{r}
data4<-expand.grid(DayF=unique(BW.Tall$DayF),
                   Treatment=unique(BW.Tall$Treatment))
  data4$TreatDay<-as.character(paste(data4$DayF, data4$Treatment, sep = "_"))
  data4$TreatDay[data4$Treatment=="A"]<-"0"
  data4$TreatDay[data4$Day=="-28"]<-"0"
  data4$TreatDay<-factor(data4$TreatDay, levels = c("0","28_N","28_N+P", "62_N","62_N+P",
                                                    "75_N", "75_N+P","91_N", "91_N+P", "100_N","100_N+P"))

data4<-data4[order(data4$Treatment, data4$DayF),]


# data4<-expand.grid(DayF=unique(BW.Tall$DayF),
                   # Treatment=unique(BW.Tall$Treatment))
# data4<-data4[order(data4$Treatment, data4$DayF),]
```


```{r}
clda_Gls_4 <- Gls(dAW.gd ~ DayF + TreatDay,
        correlation=corSymm (form = ~TimePoint|MoteGen/Fra),
        weights=varIdent(form=~1|TimePoint),
        na.action = na.omit,
        data = BW.Tall)


predictions_4 <- cbind(data4, predict (clda_Gls_4, data4, conf.int=0.95))

predictions_4$Treatment2<- factor(predictions_4$Treatment,
        levels= c("BL", "A", "N", "N+P"))
predictions_4$Treatment2[predictions_4$Day=="-28"] <- "BL"

predictions_4$Days<-as.numeric(as.character(predictions_4$Day))

# clda_Gls_4 <- Gls(dAW.gd ~ Xalt,
#         correlation=corSymm (form = ~TimePoint|Fra),
#         weights=varIdent(form=~1|TimePoint),
#         na.action = na.omit,
#         data = BW.Tall)
# 
# predictions_4 <- cbind(BW.Tall, predict (clda_Gls_4, BW.Tall, conf.int=0.95))
```


```{r}
pd <- position_dodge(2)
Colour.colour<-scale_colour_manual(values = c("black", "gray70", "gray35"))
Fill.colour<-scale_fill_manual(values = c("white", "black", "gray70", "gray35"))
limits <- aes(ymax = upper , ymin=lower, shape=Treatment2)

pCI4 <- ggplot(predictions_4, aes(y=linear.predictors, x=Days, 
                                fill=Treatment2 , shape=Treatment2)) + 
  
    
          annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                    colour = "gray90")+
          annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
        
          annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                    colour = "gray90")+
          annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
        
          annotate("segment", x = 79, xend = 91, y = -1.4, yend = 4,
                    colour = "gray90")+
        
          annotate("segment", x = 91, xend = 110, y = 4, yend = 4,
                    colour = "gray90")+
          annotate("text", x = 100, y = 3.8, label = "Heat", size=3) +
  
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Treatment, y=linear.predictors), position=pd) + 
        geom_point(position=pd, size=4, alpha=0.8) +
        scale_shape_manual(values=c(21, 21, 22, 24),
                     labels=c("BL", "A", "N", "N+P"))+
        Fill.colour+ ggthe_bw + ggtitle("a)") +
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth rate (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position=c(0.2, 0.3),
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) 

 
pCI4
```


```{r}
# predictions_4$Treatment2<- factor(predictions_4$Treatment, 
#         levels= c("BL", "A", "N", "N+P"))
#         predictions_4$Treatment2[predictions_4$DayF=="-28"] <- "BL"
# 
# 
# pd <- position_dodge(2)
# limits <- aes(ymax = upper , ymin=lower, shape=Treatment2)
# 
# pCI4 <- ggplot(predictions_4, aes(y=linear.predictors, x=Days, 
#                                 fill=Treatment2 , shape=Treatment2)) + 
#         geom_errorbar(limits, width= 2 , position=pd) + 
#         geom_line(aes(group=Treatment, y=linear.predictors), position=pd) + 
#         geom_point(position=pd, aes(fill=Treatment2), size=4, alpha=0.8) +
#         scale_shape_manual(values=c(21, 21, 22, 24),
#                      labels=c("BL", "A", "N", "N+P"))+
#         Fill.colour+
#         ggthe_bw+
#         
#         geom_hline(yintercept = 0, linetype=3)+
#       
#         scale_x_continuous(name="Days in the experiment", 
#                          breaks = seq(0, 115, by=15)) +
#         scale_y_continuous(name="Estimated growth (mg / g d) ", 
#                          breaks = seq(-1, 4, by=1)) +
#     
#         theme(text=element_text(size=14),
#           legend.position=c(0.2, 0.5),
#           legend.title = element_blank(), 
#           strip.background =element_rect(fill=NA)) +
#     
#       annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
#                 colour = "gray90")+
#       annotate("text", x = -16, y = -1.2, label = "Baseline", size=3)+
#     
#       annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
#                 colour = "gray90")+
#       annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
#     
#       annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
#                 colour = "gray90")+
#     
#       annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
#                 colour = "gray90")+
#       annotate("text", x = 99, y = -1.2, label = "Heat", size=3)
# pCI4
```

## Treatment and Genotype model

**Note:** Does not allow interaction among nutrient treatment and genotype

```{r}
fit5 <- gls(dAW.gd ~ (DayF * MoteGen) + TreatDay, data=BW.Tall,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.omit,
  control=glsControl(opt="optim"))

```

Summary model 

```{r}
summary(fit5)
  intervals(fit5)
  anova(fit5, type="marginal")  # type 3 tests
  getVarCov(fit5)
  #residuals(fit5, type="pearson")
  
  par(mfrow=c(1,2))
  plot(fitted(fit5), residuals(fit5, type="pearson"))
  abline(h=0)
  qqnorm(residuals(fit5, type="pearson"))
  abline(0,1)
```

Predictions 

```{r}
pred5<-expand.grid(DayF=unique(BW.Tall$DayF),
                    MoteGen=unique(BW.Tall$MoteGen),
                    Treatment=unique(BW.Tall$Treatment))
  pred5$TreatDay<-as.character(paste(pred5$Day, pred5$Treatment, sep = "_"))
  pred5$TreatDay[pred5$Treatment=="A"]<-"0"
  pred5$TreatDay[pred5$Day=="-28"]<-"0"
  pred5$TreatDay<-factor(pred5$TreatDay, levels = c("0","28_N","28_N+P", "62_N","62_N+P",
                                                    "75_N", "75_N+P","91_N", "91_N+P", "100_N","100_N+P"))
  
pred5<-pred5[order(pred5$Treatment, pred5$Day),]
```


```{r}
clda_Gls5 <- Gls(dAW.gd ~ DayF * MoteGen + TreatDay, 
        correlation=corSymm (form = ~TimePoint|Fra),
        weights=varIdent(form=~1|TimePoint),
        na.action=na.omit,
        data = BW.Tall)

predictions5 <- cbind(pred5, 
predict (clda_Gls5, pred5, conf.int=0.95))

predictions5$Treatment2<- factor(predictions5$Treatment, 
        levels= c("BL", "A", "N", "N+P"))
    predictions5$Treatment2[predictions5$Day=="-28"] <- "BL"

predictions5$Days<-as.numeric(as.character(predictions5$Day))
```


```{r}
pd <- position_dodge(1)
limits <- aes(ymax = upper , ymin=lower, shape=Treatment2)

pCI5 <- ggplot(predictions5, aes(y=linear.predictors, x=Days, 
                                fill=Treatment2 , shape=Treatment2)) + 
   #annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
          #          colour = "gray90")+
          #annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
        
          annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                    colour = "gray90")+
          annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
        
          annotate("segment", x = 79, xend = 91, y = -1.4, yend = 4.5,
                    colour = "gray90")+
        
          annotate("segment", x = 91, xend = 110, y = 4.5, yend = 4.5,
                    colour = "gray90")+
          annotate("text", x = 99, y = -1.2, label = "H", size=3)+
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Treatment, y=linear.predictors), position=pd) + 
        geom_point(position=pd, size=2, alpha=0.8) +
        scale_shape_manual(values=c(21, 21, 22, 24),
                     labels=c("BL", "A", "N", "N+P"))+
        Fill.colour+ ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=30)) +
        scale_y_continuous(name="Estimated growth rate (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="none",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA))
    
 
pCI5<-pCI5+facet_wrap(~MoteGen)

Growth_genotype<-grid.arrange(pCI4,BW_Col, nrow=1)
#ggsave(file="Outputs/Growth_genotype.svg", plot=Growth_genotype, width=7, height=5.5)
```


```{r}
pd <- position_dodge(1)
limits <- aes(ymax = upper , ymin=lower, shape=Treatment2)

pCI5b <- ggplot(predictions5, aes(y=linear.predictors, x=Days, 
                                fill=MoteGen , shape=Treatment2)) + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=MoteGen, y=linear.predictors), size=0.1, position=pd) + 
        geom_point(position=pd, size=4, alpha=0.8) +
        scale_shape_manual(values=c(22, 21, 21, 21),
                     labels=c("BL", "A", "N", "N+P"))+
        ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "H", size=3)
 
pCI5b+facet_wrap(~Treatment)
```

### Remove ambient from treatment-genotype mdel 

```{r}
# Claculate relative changes (1 - Ambient)
    Ambient<-subset(predictions5, Treatment=="A" )
    Ambient <- subset(Ambient, select = c(DayF, MoteGen, linear.predictors))
    colnames(Ambient)<-c("DayF", "MoteGen", "Ambient")
    N_effects<-merge(predictions5, Ambient, by=c("MoteGen", "DayF"), all.x = T)

N_effects$effects<-N_effects$linear.predictors-N_effects$Ambient          
    N_effects$effects_l<-N_effects$lower-N_effects$Ambient          
    N_effects$effects_u<-N_effects$upper-N_effects$Ambient          
    
```

```{r}
pd <- position_dodge(1)
limits <- aes(ymax = effects_u , ymin=effects_l, shape=Treatment2)

pCI5c <- ggplot(N_effects, aes(y=effects, x=Days, 
                                fill=MoteGen , shape=Treatment2)) + 
        ggthe_bw + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Treatment, y=effects), size=0.1, position=pd) + 
        geom_point(aes(fill=MoteGen),position=pd, size=4, alpha=0.8) +
        scale_shape_manual(values=c(21, 21, 22, 24),
                     labels=c("BL", "A", "N", "N+P"))+
       
      geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        #scale_y_continuous(name="Estimated growth (mg / g d) ", 
         #                breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="none",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "H", size=3)
 
pCI5c+facet_wrap(~MoteGen)
```


```{r}
# Claculate relative changes (1 - Ambient)
library(plyr)
  G.Summary<-plyr::ddply (BW.Tall, . (MoteGen, TreatDay, DayF),summarise, 
                                                G_mean = mean (dAW.gd, na.rm = F), 
                                                G_sd = sd (dAW.gd, na.rm = F))
  
  
  Ambient<-subset(G.Summary, TreatDay=="0")
  Ambient <- subset(Ambient, select = c(DayF, MoteGen, G_mean))
    colnames(Ambient)<-c("DayF", "MoteGen", "Ambient")
    N_differences<-merge(BW.Tall, Ambient, by=c("MoteGen", "DayF"), all.x = T)

N_differences$effects<-N_differences$dAW.gd-N_differences$Ambient       

N_differences$Treatment2<- factor(N_differences$Treatment, 
        levels= c("BL", "A", "N", "N+P"))
N_differences$Treatment2[N_differences$DayF=="-28"] <- "BL"
N_differences$Days<-as.character(N_differences$DayF)
N_differences$Days<-as.numeric(N_differences$Days)


pCI4 <- ggplot(N_differences, aes(y=effects, x=Days, 
                                colour=Treatment2 , shape=Treatment2)) + 
        ggthe_bw + 
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2)+
        stat_summary(aes(group=Treatment2, y=effects), fun.y=mean, geom="line") +  
        scale_shape_manual(values=c(21, 21, 22, 24),
                    labels=c("BL", "A", "N", "N+P"))+
       
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        #scale_y_continuous(name="Estimated growth (mg / g d) ", 
         #                breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="none",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -4, yend = -4,
                colour = "gray90")+
      annotate("text", x = -16, y = -3.5, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -4, yend = -4,
                colour = "gray90")+
      annotate("text", x = 45, y = -3.5, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -4, yend = -3,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -3, yend = -3,
                colour = "gray90")+
      annotate("text", x = 99, y = -3.5, label = "H", size=3)
 
pCI4+facet_wrap(~MoteGen)
    
```

## Pooled nutrient treatments * Genotype model

```{r}

BW.Tall$NutDay<-as.character(paste(BW.Tall$DayF, BW.Tall$Nutrients, sep = "_"))
  BW.Tall$NutDay[BW.Tall$Treatment=="A"]<-"0"
  BW.Tall$NutDay[BW.Tall$DayF=="-28"]<-"0"
  
  BW.Tall$NutDay<-factor(BW.Tall$NutDay)
  summary(BW.Tall$NutDay)
  BW.Tall$NutDay<-factor(BW.Tall$NutDay, levels = c("0","28_Nutrients","62_Nutrients",
                                                    "75_Nutrients", "91_Nutrients", "100_Nutrients"))
  
 BW.nutrients<-subset(BW.Tall, Days<76) # with baseline
    BW.nutrients<-droplevels(BW.nutrients)

```

```{r}
fit6 <- gls(dAW.gd ~ DayF + MoteGen * NutDay, data=BW.nutrients,
  correlation=corSymm(form=~TimePoint|Fra),
  weights=varIdent(form=~1|TimePoint),
  na.action=na.omit,
  control=glsControl(opt="optim"))

# fit6 <- lme(dAW.gd ~ DayF*MoteGen+ NutDay, data=BW.nutrients,
#             random = ~TimePoint|Fra,
#             na.action=na.omit)
```

Summary model 

```{r}
summary(fit6)
summary(fit6)$tTable

  intervals(fit6)
  anova(fit6, type="marginal")  # type 3 tests, Multivariate Wald test, F-test, type III anova
  getVarCov(fit6)
  #residuals(fit5, type="pearson")
  
  par(mfrow=c(1,2))
  plot(fitted(fit6), residuals(fit6, type="pearson"))
  abline(h=0)
  qqnorm(residuals(fit6, type="pearson"))
  abline(0,1)
```

Predictions 

```{r}
pred6<-expand.grid(DayF=unique(BW.nutrients$DayF),
                    MoteGen=unique(BW.nutrients$MoteGen),
                    Nutrients=unique(BW.nutrients$Nutrients))

  pred6$NutDay<-as.character(paste(pred6$Day, pred6$Nutrients, sep = "_"))
  pred6$NutDay[pred6$Nutrients=="Ambient"]<-"0"
  pred6$NutDay[pred6$Day=="-28"]<-"0"
  pred6$NutDay<-factor(pred6$NutDay, levels = c("0","28_Nutrients","62_Nutrients",
                                                    "75_Nutrients"))
                                                #, "91_Nutrients", "100_Nutrients"))
  
pred6<-pred6[order(pred6$Nutrients, pred6$Day),]
```


```{r}
clda_Gls6 <- Gls(dAW.gd ~ DayF + MoteGen * NutDay, 
        correlation=corSymm (form = ~TimePoint|Fra),
        weights=varIdent(form=~1|TimePoint),
        na.action=na.omit,
        data = BW.nutrients)

predictions6 <- cbind(pred6, 
predict (clda_Gls6, pred6, conf.int=0.95))

predictions6$Nutrients2<- factor(predictions6$Nutrients, 
        levels= c("BL", "Ambient", "Nutrients"))
    predictions6$Nutrients2[predictions6$Day=="-28"] <- "BL"

predictions6$Days<-as.numeric(as.character(predictions6$Day))
```


```{r}
pd <- position_dodge(1)
limits <- aes(ymax = upper , ymin=lower, shape=Nutrients2)

pCI6 <- ggplot(predictions6, aes(y=linear.predictors, x=Days, 
                                fill=Nutrients2 , shape=Nutrients2)) + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Nutrients, y=linear.predictors), position=pd) + 
        geom_point(position=pd, size=4, alpha=0.8) +
        scale_shape_manual(values=c(21, 21, 22, 24),
                     labels=c("BL", "A", "N", "N+P"))+
       # Fill.colour+
        ggthe_bw+
        
        geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        scale_y_continuous(name="Estimated growth (mg / g d) ", 
                         breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="right",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "H", size=3)
 
pCI6+facet_wrap(~MoteGen)
```

### Remove ambient from treatment-genotype mdel 


```{r}
# Claculate relative changes (1 - Ambient)
    Ambient<-subset(predictions6, Nutrients=="Ambient" )
    Ambient <- subset(Ambient, select = c(DayF, MoteGen, linear.predictors))
    colnames(Ambient)<-c("DayF", "MoteGen", "Ambient")
    N_effects<-merge(predictions6, Ambient, by=c("MoteGen", "DayF"), all.x = T)

N_effects$effects<-N_effects$linear.predictors-N_effects$Ambient          
    N_effects$effects_l<-N_effects$lower-N_effects$Ambient          
    N_effects$effects_u<-N_effects$upper-N_effects$Ambient          
    
```

```{r}
pd <- position_dodge(1)
limits <- aes(ymax = effects_u , ymin=effects_l, shape=Nutrients2)

pCI5c <- ggplot(N_effects, aes(y=effects, x=Days, 
                                fill=MoteGen , shape=Nutrients2)) + 
        ggthe_bw + 
        geom_errorbar(limits, width= 2 , position=pd) + 
        geom_line(aes(group=Nutrients, y=effects), size=0.1, position=pd) + 
        geom_point(aes(fill=MoteGen),position=pd, size=4, alpha=0.8) +
        scale_shape_manual(values=c(21, 21, 22, 24),
                     labels=c("BL", "A", "N", "N+P"))+
       
      geom_hline(yintercept = 0, linetype=3)+
      
        scale_x_continuous(name="Days in the experiment", 
                         breaks = seq(0, 115, by=15)) +
        #scale_y_continuous(name="Estimated growth (mg / g d) ", 
         #                breaks = seq(-1, 4, by=1)) +
    
        theme(text=element_text(size=14),
          legend.position="none",
          legend.title = element_blank(), 
          strip.background =element_rect(fill=NA)) +
    
      annotate("segment", x = -30, xend = -2, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = -16, y = -1.2, label = "BL", size=3)+
    
      annotate("segment", x = 2, xend = 91, y = -1.5, yend = -1.5,
                colour = "gray90")+
      annotate("text", x = 45, y = -1.2, label = "Nutrients", size=3)+
    
      annotate("segment", x = 79, xend = 91, y = -1.4, yend = -1,
                colour = "gray90")+
    
      annotate("segment", x = 91, xend = 110, y = -1, yend = -1,
                colour = "gray90")+
      annotate("text", x = 99, y = -1.2, label = "H", size=3)
 
pCI5c+facet_wrap(~MoteGen)
```
