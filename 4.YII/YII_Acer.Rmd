---
title: "Changes in Fv/Fm in elevated nutrients and heat stress (Only *A.cer*)"
author: "Ana Palacio"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    df_print: paged
    theme: united
bibliography: packages.bib
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE, fig.width=7, fig.height=7)
```


# General project set-up 

```{r libraries, results="hide"}

# Load libraries and sources required to run the script
    library(tidyverse)
    library(ggthemes)
    library(lmerTest)
    library(emmeans)
    library(multcomp)
    library(effects)
    library(gridExtra)
    library(rstatix)

# Default ggplot settings

   Fill.colour<-scale_colour_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))

    ggthe_bw<-theme_bw() + theme(panel.grid.major = element_blank(), 
                    panel.grid.minor = element_blank(),
                    #panel.background = element_blank(), 
                    axis.line = element_line(colour = "black"),
                    plot.background=element_blank(),
                    legend.title = element_blank(), 
                    legend.box.background = element_rect(),
                    panel.background =element_rect(fill = NA, color = "white"),
                    legend.position="bottom",
                    strip.background =element_rect(fill=NA))
```

# Data exploration

##  1. Get the files with all the YII by species

Metadata

```{r, data}
  YII.data<-read.csv("YII_Data/All_YII_data.csv", header = T)
  YII.Acer<-subset(YII.data, Spp=="Ac")
  YII.Acer<-droplevels(YII.Acer)
  summary(YII.Acer)
```

Merge/Transform

```{r}
# Organize data type
      YII.Acer$Date<-as.Date(YII.Acer$Date, "%Y-%m-%d")
      YII.Acer$Days<-(as.numeric(YII.Acer$Date) -17485)
      #Time as a factor, not as int
      str(YII.Acer)
      YII.Acer$DaysF<-as.factor(YII.Acer$Days)

      YII.Acer$Treatment <- as.factor(YII.Acer$Treatment)
      
      YII.Acer$Genotype<-factor(as.character(YII.Acer$Genotype), 
                             levels=c("G_48", "G_62","G_31", 
                                      "G_08","G_07", "G_50"
                            ))  # Survivorship order

# Differentiate ambient from elevated nutrients (N and N+P)      
      YII.Acer$Nutrients<-"Nutrients"
      YII.Acer$Nutrients[YII.Acer$Treatment=="A"]<-"Ambient"
 
# Check the data
      str(YII.Acer)
      summary(YII.Acer)
```

Remove / subset timepoints
```{r}
 # Remove baseline values
      YII.Acer<-subset(YII.Acer, Days>-1)
    # Remove recovery values
      YII.Acer<-subset(YII.Acer, Days<112)
      # write.csv(YII.data, "Outputs/Experiment_YII_data.csv", row.names = F)  
    # YII.Wide<- reshape(YII.data, idvar = "Fragment", timevar = "Days", direction = "wide")
      
      Spp.fragments<-YII.Acer %>% 
        group_by(Spp, Genotype, Treatment, Replicate) %>% count(Fragment)
      Spp.fragments
      #write.csv(Spp.fragments, "Outputs/Meassurments_perFragments.csv", row.names = F)

# Subset data 
      YII.nutrients<-subset(YII.Acer, Days<80)
      YII.heat<-subset(YII.Acer, Days>75)

```


## 2. Exploratory graphs

All time points (nutrients + heat stress)

* Colony (Genotype) differences

```{r explore}
YII_Colony<- ggplot(YII.Acer, aes (Days, YII, colour=Genotype)) +
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.5)+
        stat_summary(fun.y=mean, geom="line", alpha=0.6) +   theme_bw()
    YII_Colony + ylim(0.0, 0.65) + facet_grid (Spp~Treatment)
      
YII_Frag_Gen<- ggplot(YII.Acer, aes (Days, YII, colour=Genotype, group=Fragment)) +
        stat_summary(fun.y=mean, geom="line", alpha=0.5) +  
        theme_bw() + theme(legend.position = "bottom",
                           legend.title = element_blank())
    YII_Frag_Gen + ylim(0.0, 0.65) + facet_grid (Spp~Treatment)
```

# 3. Treatment effect (A, N and N+P)

## Figure S3: Treatments overall and by genotype

```{r Figure, fig.height = 3, fig.width = 3.5}

Colour.colour<-scale_colour_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))
Fill.colour<-scale_fill_manual(values = c ("#4A6CAA", "#469B53", "#AA4A74"))

YII_Treat<- ggplot(data=YII.Acer, aes (Days, YII,fill=Treatment, shape=factor(Treatment))) + 
      scale_shape_manual(values=c(21, 22, 24), labels=c("Ambient", "NH4", "NH4+PO4"))+
      ggthe_bw + Fill.colour + ggtitle("b") +
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 1,
                     position = position_dodge(1) )+
        stat_summary(fun.y=mean, geom="line", position = position_dodge(1), 
                     linetype=1, alpha=1) + 
         stat_summary(fun.y=mean, geom="point", size =2,
                   position=position_dodge(width=1), alpha=0.8)  +
       scale_y_continuous(limits = c(0.1, 0.7),
                           breaks = seq(0.1, 0.6, 0.1),  
                           expand = c(0, 0),
                           name=expression(~italic("Fv / Fm"))) +
       scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 15),  
                           expand = c(0, 0))+
      annotate("segment", x = 2, xend = 91, y = 0.12, yend = 0.12,
                  colour = "gray35", linetype=2)+
      annotate("segment", x = 79, xend = 90, y = 0.12, yend = 0.20,
                  colour = "gray35", linetype=3)+
      annotate("segment", x = 91, xend = 110, y = 0.20, yend = 0.20,
                  colour = "gray35", linetype=3)+
      annotate("text", x = 45, y = 0.15, label = "Nutrients", size=3)+
      annotate("text", x = 99, y = 0.15, label = "Heat", size=3)
YII_Treat

FigureS3<-YII_Treat + facet_wrap (Genotype ~.)
FigureS3
#ggsave(file="Outputs/Fig_3b_Acer_YII_Treat.svg", plot=FigureS3, width=5.5, height=5)
```

## Model 1: onlyu treatments (A, N and N+P)

```{r Acer_models}

# 1. Find the best model

YII.Acer$DaysF<-as.factor(YII.Acer$Days)

Model1<-lmerTest::lmer(YII ~ Treatment * DaysF + 
                             (1|Genotype) + (1|Replicate) +  (1|Fragment), 
                              data=YII.Acer, na.action=na.omit)
      summary(Model1)
      
      Step.LME_Acer<-step (Model1) # Replicate is not significant
      anova(Model1)
      ranova(Model1)# Replicate is not significant
      summary(Model1)
      
#2. Extract EMMs
      Acer.YII.emm<-emmeans(Model1, ~Treatment | DaysF)
      contrast(Acer.YII.emm, "tukey")
      
      Acer.YII.emm<-emmeans(Model1, ~Treatment * DaysF)
      
      # Effect plot options
      #emmip(Model1, ~DaysF|Treatment, CIs = TRUE) + theme_bw() # interaction plot of predictions
      
      Acer.YII_groups<-cld(Acer.YII.emm, by=NULL) # compact-letter display
      Acer.YII_groups<-Acer.YII_groups[order(Acer.YII_groups$Treatment, Acer.YII_groups$Day),]
      Acer.YII_groups
      #write.csv(Acer.YII_groups, "Outputs/Multicomp_AcerYII.csv", row.names = F)
```


# 4. Pooled N and N+P versus A.

## Figure 4

```{r}
YII.AcerB<-YII.Acer
YII.AcerB<-subset(YII.AcerB, Sample!="Ac_103_T11")

YII_Genotype<- ggplot(data=YII.AcerB, aes (Days, YII, colour=factor(Genotype))) +
        ggthe_bw + 
  
  annotate("segment", x = 2, xend = 91, y = 0.05, yend = 0.05,
                  colour = "gray35", linetype=2)+
  annotate("segment", x = 79, xend = 91, y = 0.06, yend = 0.65,
                  colour = "gray35", linetype=3)+
  annotate("segment", x = 91, xend = 110, y = 0.65, yend = 0.65,
                  colour = "gray35", linetype=3)+
  
   annotate("text", x = 45, y = 0.02, label = "Nutrients", size=3)+
        annotate("text", x = 100, y = 0.61, label = "Heat", size=3)+
  
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 1,
                     position = position_dodge(1), alpha=0.5 )+
  #stat_summary(fun.y=mean, geom="line", position = position_dodge(1), linetype=1, alpha=1) + 
  stat_summary(fun.y=mean, geom="point", size =2,
                   position=position_dodge(width=1), alpha=0.5)  +
  theme(legend.position="bottom", 
              legend.title = element_blank(),
              strip.background = element_rect(fill="white"))+
  scale_y_continuous(limits = c(0.0, 0.7),
                           breaks = seq(0.0, 0.6, 0.1),  
                           expand = c(0, 0),
                           name=expression(~italic("Fv / Fm"))) +
  scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 15),  
                           expand = c(0, 0))+
  facet_grid (~Nutrients)

Figure4 <- YII_Genotype + geom_smooth(method = "loess", span=0.4, alpha=0.1, size=0.5)
Figure4
#ggsave(file="Outputs/Figure4.svg", plot=Figure4, width=6.5, height=5.5)
```


## Model 2: Nutrient Treatments (A versus elevated nutrients)

```{r Acer_model2}

# 1. Find the best model

Model2<-lmerTest::lmer(YII ~ Genotype* Nutrients * DaysF + 
                             (1|Replicate) +  (1|Fragment), 
                              data=YII.Acer, na.action=na.omit)
    
      #step (Model2) # Replicate is not significant
      anova(Model2)
      ranova(Model2)# Replicate is not significant
      summary(Model2)
      
#2. Extract EMMs
      Acer.YII.emm2<-emmeans(Model2, ~ Genotype| Nutrients | DaysF)
      contrast(Acer.YII.emm2, "tukey")
      
      Acer.YII.emm2<-emmeans(Model2, ~ Genotype*Nutrients * DaysF)
      
      Acer.YII_groups<-cld(Acer.YII.emm2, by=NULL) # compact-letter display
      Acer.YII_groups<-Acer.YII_groups[order(
                        Acer.YII_groups$Day, 
                        Acer.YII_groups$Nutrients, 
                        Acer.YII_groups$Genotype),]
      Acer.YII_groups
      #write.csv(Acer.YII_groups, "Outputs/Multicomp_AcerYII.csv", row.names = F)
```


# Supporting plots

* Treatment effect by genotype

```{r FigureSupple1,  fig.height = 7, fig.width = 8}

FigureS3_genotype<-YII_Treat_BW<- ggplot(data=YII.Acer, aes (Days, YII, colour=factor(Nutrients), shape=factor(Nutrients))) +
        ggthe_bw + Fill.colour+
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 5,
                     position = position_dodge(1) )+
        stat_summary(fun.y=mean, geom="line", position = position_dodge(1), 
                     linetype=1, alpha=1) + 
         stat_summary(fun.y=mean, geom="point", size =1,
                   position=position_dodge(width=1), alpha=0.5)  +
        theme(axis.title.y=element_text(size=12), 
          legend.position="bottom",
          legend.title = element_blank()) + ggtitle("b") +
      
    scale_y_continuous(limits = c(0.0, 0.7),
                           breaks = seq(0.0, 0.6, 0.1),  
                           expand = c(0, 0),
                           name=expression(~italic("Fv / Fm"))) +
        scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 30),  
                           expand = c(0, 0))+
        annotate("segment", x = 2, xend = 91, y = 0.12, yend = 0.12,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 79, xend = 91, y = 0.12, yend = 0.20,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 91, xend = 110, y = 0.20, yend = 0.20,
                  colour = "gray90", linetype=1)+
        annotate("text", x = 45, y = 0.05, label = "Nutrients", size=3)+
        annotate("text", x = 99, y = 0.05, label = "H", size=3) +
  facet_wrap(~Genotype)
FigureS3_genotype
  
#ggsave(file="Outputs/S3b_YII_Treat_Colo.svg", plot=Figure3_genotype, width=6.0, height=3.5)
```


* Figure S: Treatment difference by genotype

```{r FigureSupple2,  fig.height = 7, fig.width = 8}
YII.Acer$Nutrients2<-YII.Acer$Nutrients
YII.Acer$Nutrients2[YII.Acer$DaysF=="1"]<-"Ambient"
          
    YII.Summary <-YII.Acer %>%
          group_by(Genotype, Nutrients2, DaysF) %>%
          get_summary_stats(YII, type = "mean_sd")
    YII.Summary
    
   YII.Summary<-subset(YII.Summary, Nutrients2=="Ambient" )
    YII.Summary<-YII.Summary[, -3]
    YII.Summary<-YII.Summary[, -3]
    YII.Summary<-YII.Summary[, -3]
    
    YII.Acer<-merge(YII.Acer, YII.Summary,  by=c("Genotype", "DaysF"), all.x = T)
    YII.Acer$Difference<-YII.Acer$YII-YII.Acer$mean

FigureS4_genotype<-YII_Treat_BW<- ggplot(data=YII.Acer, aes (Days, Difference, colour=factor(Nutrients), shape=factor(Nutrients))) +
        geom_smooth()+
        ggthe_bw + Fill.colour+
          stat_summary(fun.y=mean, geom="point", size =2,
                   position=position_dodge(width=1), alpha=0.5)  +
          stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 5,
                     position = position_dodge(1) )+
       
          theme(axis.title.y=element_text(size=12), 
            legend.position="bottom",
            legend.title = element_blank(),
            strip.background =element_rect(fill=NA)) +
  ggtitle("b)") +
      
    scale_y_continuous(limits = c(-0.3, 0.1),
                           breaks = seq(-0.4, 0.1, 0.1),  
                           expand = c(0, 0),
                           name=expression(~italic("Fv / Fm"))) +
        scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 30),  
                           expand = c(0, 0))+
        annotate("segment", x = 2, xend = 91, y = 0.12, yend = 0.12,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 79, xend = 91, y = 0.12, yend = 0.65,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 91, xend = 110, y = 0.65, yend = 0.65,
                  colour = "gray90", linetype=1)+
        annotate("text", x = 45, y = 0.05, label = "Nutrients", size=3)+
        annotate("text", x = 99, y = 0.05, label = "H", size=3) +
  facet_wrap(~Genotype)
FigureS4_genotype
  
#ggsave(file="Outputs/S3b_YII_Treat_Colo.svg", plot=Figure3_genotype, width=6.0, height=3.5)
```

* Figure S4: Treatment difference by genotype N and N+P pooled

```{r FigureSupple3,  fig.height = 7, fig.width = 8}

    YII.Summary <-YII.Acer %>%
          group_by(Genotype, Treatment, DaysF) %>%
          get_summary_stats(YII, type = "mean_sd")
    YII.Summary
    
   YII.Summary<-subset(YII.Summary, Treatment=="Ambient" )
    YII.Summary<-YII.Summary[, -3]
    YII.Summary<-YII.Summary[, -3]
    YII.Summary<-YII.Summary[, -3]
    
    #YII.Acer<-merge(YII.Acer, YII.Summary,  by=c("Genotype", "DaysF"), all.x = T)
    YII.Acer$Difference2<-YII.Acer$YII-YII.Acer$mean

YII.Acer$Percentaje2 <- (YII.Acer$Difference2/YII.Acer$mean)*100
#Colour.colour<-scale_colour_manual(values = c("black", "gray70"))
#Fill.colour<-scale_fill_manual(values = c("black", "gray70"))


FigureS4b_genotype<-YII_Treat_BW<- ggplot(data=YII.Acer, aes (Days, Percentaje2, 
                    colour=factor(Treatment), fill=factor(Treatment), shape=factor(Treatment))) +
        annotate("segment", x = 2, xend = 91, y = -35, yend = -35,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 79, xend = 91, y = -34, yend = 10,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 91, xend = 110, y = 10, yend = 10,
                  colour = "gray90", linetype=1)+
        annotate("text", x = 45, y = -40, label = "Nutrients", size=3)+
        annotate("text", x = 101, y = 13, label = "H", size=3) +
        
        geom_smooth()+      
  
        #stat_summary(fun.y=mean, geom="point", size =2,
        #           position=position_dodge(width=1), alpha=0.5)  +
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 5,
                      position = position_dodge(1) )+
       
  #ggtitle("b)") +
  #scale_shape_manual(values=c(21, 14),
  #                   labels=c("A", "N and N+P"))+
  ggthe_bw + #Fill.colour+ Colour.colour +
      
    scale_y_continuous(limits = c(-45, 25),
                           breaks = seq(-40, 25, 10),  
                           expand = c(0, 0),
                           name="Fv/Fm  change respect to A (%)") +
        scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 30),  
                           expand = c(0, 0))+

   theme(axis.title.y=element_text(size=12), 
          legend.position="bottom",
          legend.title = element_blank(),
           strip.background =element_rect(fill=NA)) +
  facet_wrap(~Genotype)
FigureS4b_genotype
  
#ggsave(file="Outputs/S4_YII_Treat_Colo.svg", plot=FigureS4_genotype, width=5.0, height=5.5)
```

* Figure S4: Treatment difference by genotype N and N+P separated

```{r FigureSupple4,  fig.height = 7, fig.width = 8}

YII.Acer$Percentaje<- (YII.Acer$Difference/YII.Acer$mean)*100
Colour.colour<-scale_colour_manual(values = c("black", "gray70"))
Fill.colour<-scale_fill_manual(values = c("black", "gray70"))
YII.Acer$Nutrients2<factor(YII.Acer$Nutrients2, levels = c("Nutrients", "Ambient"))

FigureS4_genotype<-YII_Treat_BW<- ggplot(data=YII.Acer, aes (Days, Percentaje, 
                    colour=factor(Nutrients2), fill=factor(Nutrients2), shape=factor(Nutrients2))) +
        annotate("segment", x = 2, xend = 91, y = -35, yend = -35,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 79, xend = 91, y = -34, yend = 10,
                  colour = "gray90", linetype=1)+
        annotate("segment", x = 91, xend = 110, y = 10, yend = 10,
                  colour = "gray90", linetype=1)+
        annotate("text", x = 45, y = -40, label = "Nutrients", size=3)+
        annotate("text", x = 101, y = 13, label = "H", size=3) +
        
        geom_smooth()+      
  
        #stat_summary(fun.y=mean, geom="point", size =2,
        #           position=position_dodge(width=1), alpha=0.5)  +
        stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 5,
                      position = position_dodge(1) )+
       
  #ggtitle("b)") +
  scale_shape_manual(values=c(21, 14),
                     labels=c("A", "N and N+P"))+
  ggthe_bw + Fill.colour+ Colour.colour +
      
    scale_y_continuous(limits = c(-45, 25),
                           breaks = seq(-40, 25, 10),  
                           expand = c(0, 0),
                           name="Fv/Fm  change respect to A (%)") +
        scale_x_continuous(name="Days in the experiment",
                           limits = c(-1,113),
                           breaks = seq(0, 113, 30),  
                           expand = c(0, 0))+

   theme(axis.title.y=element_text(size=12), 
          legend.position="bottom",
          legend.title = element_blank(),
           strip.background =element_rect(fill=NA)) +
  facet_wrap(~Genotype)
FigureS4_genotype
  
#ggsave(file="Outputs/S4_YII_Treat_Colo.svg", plot=FigureS4_genotype, width=5.0, height=5.5)
```


### Subset timepoints

```{r}
summary(YII.Acer$DaysF)
YII.Acer1<-subset(YII.Acer, DaysF=="1")
YII.Acer76<-subset(YII.Acer, DaysF=="76")
YII.Acer92<-subset(YII.Acer, DaysF=="92")
YII.Acer110<-subset(YII.Acer, DaysF=="110")

YII.AcerTimePoints<-rbind(YII.Acer1, YII.Acer76, YII.Acer92, YII.Acer110)

YII_Timepoints<- ggplot(YII.AcerTimePoints, aes (DaysF, YII, fill=Genotype, shape=Nutrients2)) +
  #ggtitle("(a) Baseline")+
  ggthe_bw +
  scale_shape_manual(values=c(21, 14),
                     labels=c("A", "N and N+P"))+
  
  stat_summary(fun.y=mean, geom="point", size =2, alpha=0.9) + 
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  scale_y_continuous(name=("Fv/Fm"),
                     limits = c(0.1, 0.65),
                     breaks = seq(0, 0.7, by=0.1))+
  theme(legend.position="right",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))+ 
  facet_grid(~Genotype)
YII_Timepoints

YII_Timepoints<- ggplot(YII.AcerTimePoints, aes (Genotype, YII, fill=Genotype, shape=Nutrients2)) +
  #ggtitle("(a) Baseline")+
  scale_shape_manual(values=c(21, 14),
                     labels=c("A", "N and N+P"))+
  stat_summary(fun.y=mean, geom="point", size =2, alpha=1) + 
    stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  ggthe_bw +
  scale_y_continuous(name=("Fv/Fm"),
                     limits = c(0.1, 0.65),
                     breaks = seq(0, 0.7, by=0.1))+
  theme(legend.position="right",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))+ 
  facet_grid(~DaysF)
YII_Timepoints

#ggsave(file="Outputs/S4_YII_Treat_Colo.svg", plot=YII_Timepoints, width=5.5, height=3.0)
```


# Supporting GLMs

## Genotypic differences with subset

```{r}
 ## Data subsets  
summary(YII.Acer)
    YII.0<-subset(YII.Acer, DaysF=="1") # Only baseline
    YII.0<-droplevels(YII.0)
   
    YII.Control<-subset(YII.Acer, Treatment=="A") # Only Ambient
    YII.Control<-subset(YII.Control, Days<77)
    YII.Control<-droplevels(YII.Control)
    summary(YII.Control)
    
    YII.FinalAC<-subset(YII.Control, DaysF=="76")
    YII.FinalAC<-droplevels(YII.FinalAC)
    
    #BW.nutrients<-subset(BW.Tall, Days>-10) # Remove baseline
    #BW.nutrients<-subset(BW.nutrients, Days<76)
    YII.nutrients<-subset(YII.Acer, Days<76) # with baseline
    YII.nutrients<-droplevels(YII.nutrients)
    summary(YII.nutrients)
```

### Baseline

```{r}
YII_Init<- ggplot(YII.0, aes (Genotype, YII, colour=Genotype)) +
   ggtitle("(a) Baseline")+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.5) + ggthe_bw +
  scale_y_continuous(name=("Fv/Fm"),
                     limits = c(0.46, 0.62),
                     breaks = seq(0.46, 0.62, by=0.02))+
   theme(legend.position="none",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))
YII_Init
```

```{r}
# ANOVA
  LM_bl <- lm(YII ~ Genotype, data= YII.0)
  anova(LM_bl)

# Pairwise comparisons
  BW_bl.emmc<-emmeans(LM_bl, ~ Genotype)
  contrast(BW_bl.emmc, "tukey")
  
#Tukey groups
  BW_bl_groups<-cld(BW_bl.emmc)
  BW_bl_groups
  #write.csv(BW_bl_groups, "Outputs/BW_baseline_groups.csv", row.names = F)

# N fragments    
  N0.fragments<-YII.0 %>% 
     group_by(Genotype) %>% count(Genotype)
  N0.fragments

```


### Ambient final day

```{r}
YII_76<- ggplot(YII.FinalAC, aes (Genotype, YII, colour=Genotype)) +
   ggtitle("(b) Ambient (day 76)")+
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2) +
  stat_summary(fun.y=mean, geom="point", size =3, alpha=0.5) + ggthe_bw +
  scale_y_continuous(name=("Fv/Fm"),
                     limits = c(0.46, 0.62),
                     breaks = seq(0.46, 0.62, by=0.02))+
   theme(legend.position="none",
        legend.title = element_blank(), 
        strip.background =element_rect(fill=NA))
YII_76
```



```{r}
summary(YII.FinalAC)

# Model
  LM_A_C.75 <- lmer(YII ~ Genotype + (1|Replicate), data= YII.FinalAC)
  isSingular(LM_A_C.75)
  anova(LM_A_C.75) # 
  ranova(LM_A_C.75) # Replicate is not significant

# Pairwise comparisons
  YII_A_C75.emmc<-emmeans(LM_A_C.75, ~Genotype)
  #contrast(BW_A_C.emmc, "tukey")
  
#Tukey groups
  YII_A_C75_groups<-cld(YII_A_C75.emmc)
  YII_A_C75_groups
  #write.csv(YII_A_C75_groups, "Outputs/YII_A_C75_groups.csv", row.names = F)

# N fragments    
  N.fragments_A_C75<-YII.FinalAC %>% 
     count(Genotype)
  N.fragments_A_C75

```

```{r}
Captivityeffect<-grid.arrange(YII_Init,YII_76, nrow=1)
#ggsave(file="Outputs/S_Genotypes.svg", plot=Captivityeffect, width=6, height=3.5)
```

* Ambient and Control evolution

```{r}
summary(YII.Control)

# Model
  LM_A_C <- lmer(YII ~ Genotype * DaysF + 
                  (1|Fragment)+ (1|Replicate), data=YII.Control)
  anova(LM_A_C) # Day alone is not significant, but Day:Genet is 
  ranova(LM_A_C) # Replicate is not significant
  step(LM_A_C)

# Pairwise comparisons
  BW_A_C.emmc<-emmeans(LM_A_C, ~Genotype * DaysF)
  #contrast(BW_A_C.emmc, "tukey")
  
#Tukey groups
  BW_A_C_groups<-cld(BW_A_C.emmc)
  BW_A_C_groups<-BW_A_C_groups[order(BW_A_C_groups$Genotype,BW_A_C_groups$Day),]
  BW_A_C_groups
  
  #write.csv(BW_A_C_groups, "Outputs/BW_A_C_groups.csv", row.names = F)

# N fragments    
  N.fragments_A_C<-YII.Control %>% 
     group_by(Genotype) %>% count(DaysF)
  N.fragments_A_C

```

```{r}
# 1. Model 
  LM_A_C <- lmer(YII ~ Genotype * Days + 
                  (1|Fragment)+ (1|Replicate), data=YII.Control)
  anova(LM_A_C) # Day alone is not significant, but Day:Genet is 
  ranova(LM_A_C) # Replicate is not significant
  step(LM_A_C)

# 2. Predict values:
  pred_ambient <- predict(LM_A_C,re.form = NA)

#3. Bootstrap CI:
  ambient.boot1 <- bootMer(LM_A_C, predict, nsim = 1000, re.form = NULL) # include random effects, reduce CI lot!
    std.err <- apply(ambient.boot1$t, 2, sd)
    CI.lo_1 <- pred_ambient - std.err*1.96
    CI.hi_1 <- pred_ambient + std.err*1.96

  #Plot
  Model_ambients_plot<- ggplot(
    YII.Control, aes(x = Days, y = YII, colour =Genotype)) +
    geom_line(aes(y = pred_ambient),size=2) +
    #geom_point(aes(fill=factor(Treatment)),
    #         shape = 21, colour = "black", size = 2, stroke = 0.3, alpha=0.3) +
    geom_ribbon(aes(ymin = CI.lo_1, ymax = CI.hi_1),
                size=2, alpha = 0.1, linetype = 0) +
    #scale_color_manual(values=my_colours) +
    #scale_fill_manual(values=my_colours) +
    scale_y_continuous(name=expression(~italic("YII")),
                      limits = c(0.45,0.65), 
                      breaks = seq(0.45, 0.65, by=0.02), expand = c(0,0))+
    scale_x_continuous("Days in the experiment", limits = c(-0, 78),
                     breaks = seq(-30, 76, by=15), expand = c(0,0))+
    
    stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 1,
                   position = position_dodge(1) )+
    stat_summary(fun.y=mean, geom="line", position = position_dodge(1), 
                linetype=1, alpha=0.5) + ggthe_bw
  
  Model_ambients_plot
```


